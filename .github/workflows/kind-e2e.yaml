name: kind-e2e

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kind
        run: |
          curl -Lo kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
          chmod +x kind
          sudo mv kind /usr/local/bin/kind

      - name: Install kubectl
        run: |
          curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s \
          https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Install Terraform
        run: |
          TF_VER="1.5.7"
          curl -LO https://releases.hashicorp.com/terraform/${TF_VER}/terraform_${TF_VER}_linux_amd64.zip
          sudo apt-get update && sudo apt-get install -y unzip
          rm -rf /tmp/terraform-bin
          mkdir -p /tmp/terraform-bin
          unzip -o terraform_${TF_VER}_linux_amd64.zip -d /tmp/terraform-bin
          sudo mv /tmp/terraform-bin/terraform /usr/local/bin/terraform
          terraform version
        
      - name: Run platform + app e2e (make ci)
        run: |
          make ci

      - name: Debug on failure (pods + events)
        if: failure()
        run: |
          echo ">> Namespaces"
          kubectl get ns
          echo ">> Pods in apps-dev"
          kubectl get pods -n apps-dev -o wide
          echo ">> Deployment describe"
          kubectl describe deploy demo-app -n apps-dev || true
          echo ">> Recent events"
          kubectl get events -A | tail -n 50

      - name: Cleanup (always)
        if: always()
        run: |
          make cleanup
